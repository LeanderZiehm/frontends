<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Notes</title>
  <link rel="stylesheet" href="index.css">
  </link>
</head>

<body>

  <div id="tabs"></div>

  <div id="top-right-buttons">
    <button id="btn-search" title="Search (Ctrl+K)" class="top-btn">üîç</button>
    <button id="btn-picker" title="Open File Picker (Ctrl+E)" class="top-btn">üìÑ</button>
    <button id="btn-help" title="Keyboard Shortcuts" class="top-btn">‚ùì</button>
  </div>

  <!-- Help overlay -->
  <div id="help-overlay"
    style="display:none; position:absolute; top:20%; left:50%; transform:translateX(-50%); background:#2c2c2c; color:#fff; padding:15px; border-radius:8px; max-width:400px; font-family:monospace; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.5);">
    <h3 style="margin-top:0; text-align:center;">Keyboard Shortcuts</h3>
    <ul style="list-style:none; padding-left:0;">
      <li>alt+h : Toggle this Help Overlay</li>
      <li>alt+N : New Tab</li>
      <li>Ctrl+S : Save Tab</li>
      <li>alt+W : Close Tab</li>
      <li>F2 : Rename Tab</li>
      <li>Ctrl+K or Alt+F : Search in Notes</li>
      <li>Ctrl+E or Ctrl+P : Open File Picker</li>
      <li>Esc : Close Search / Picker / Help</li>
    </ul>
  </div>

  <textarea id="editor" spellcheck="false"></textarea>

  <div id="search-bar">Search: <input type="text" id="search-input"></div>
  <div id="picker-overlay">
    <input type="text" id="picker-input" placeholder="Type to filter..." />
    <div id="picker-list"></div>
  </div>

  <script>
    /* --- Editor State --- */
    let files = [];        // all notes ever created
    let openTabs = [];     // currently open tabs (ids)
    let activeTabId = null;
    let isProgrammaticChange = false;

    /* --- DOM --- */
    const tabsContainer = document.getElementById('tabs');
    const editor = document.getElementById('editor');
    const searchBar = document.getElementById('search-bar');
    const searchInput = document.getElementById('search-input');
    const pickerOverlay = document.getElementById('picker-overlay');
    const pickerInput = document.getElementById('picker-input');
    const pickerList = document.getElementById('picker-list');

    /* --- Top Right Buttons --- */
    const btnSearch = document.getElementById('btn-search');
    const btnPicker = document.getElementById('btn-picker');
    const btnHelp = document.getElementById('btn-help');
    const helpOverlay = document.getElementById('help-overlay');

    /* --- Top Right Buttons with Toggle --- */
    btnSearch.onclick = () => {
      toggleSearch();
    };

    btnPicker.onclick = () => {
      togglePicker();
    };

    btnHelp.onclick = () => {
      toggleHelp();
    };

    /* --- LocalStorage Helpers --- */
    function saveState() {
      localStorage.setItem('editor-files', JSON.stringify(files));
      localStorage.setItem('editor-openTabs', JSON.stringify(openTabs));
      localStorage.setItem('editor-activeTabId', activeTabId);
    }

    function loadState() {
      files = JSON.parse(localStorage.getItem('editor-files') || '[]');
      openTabs = JSON.parse(localStorage.getItem('editor-openTabs') || '[]');
      activeTabId = Number(localStorage.getItem('editor-activeTabId')) || null;
    }

    /* --- Tabs --- */
    function createFile(name = 'Untitled', content = '') {
      const id = Date.now();
      const file = { id, name, content };
      files.push(file);
      openFile(id);
      saveState();
    }

    function openFile(id) {
      if (!openTabs.includes(id)) openTabs.push(id);
      setActiveTab(id);
    }

    function renderTabs() {
      tabsContainer.innerHTML = '';
      openTabs.forEach(id => {
        const file = files.find(f => f.id === id);
        if (!file) return;

        const tabEl = document.createElement('div');
        tabEl.className = 'tab' + (id === activeTabId ? ' active' : '');
        tabEl.textContent = file.name;
        tabEl.onclick = () => setActiveTab(id);

        const closeBtn = document.createElement('span');
        closeBtn.className = 'close';
        closeBtn.textContent = '√ó';
        closeBtn.onclick = e => { e.stopPropagation(); closeTab(id); };

        tabEl.appendChild(closeBtn);
        tabsContainer.appendChild(tabEl);
      });

      const newBtn = document.createElement('div');
      newBtn.className = 'tab';
      newBtn.textContent = '+';
      newBtn.onclick = () => createFile(getCurrentTimestamp());
      tabsContainer.appendChild(newBtn);
    }

    function setActiveTab(id) {
      const file = files.find(f => f.id === id);
      if (!file) return;

      activeTabId = id;

      isProgrammaticChange = true;
      editor.value = file.content;
      setTimeout(() => { isProgrammaticChange = false; }, 0);

      renderTabs();
      saveState();
    }

    function closeTab(id) {
      openTabs = openTabs.filter(tid => tid !== id);
      if (activeTabId === id) {
        activeTabId = openTabs[0] || null;
        editor.value = activeTabId ? files.find(f => f.id === activeTabId).content : '';
      }
      renderTabs();
      saveState();
    }

    /* --- Save --- */
    function saveTab() {
      if (!activeTabId && editor.value.trim() !== '') {
        createFile(getCurrentTimestamp(), editor.value);
        showSaveFeedback();
        return;
      }
      if (!activeTabId) return;

      const file = files.find(f => f.id === activeTabId);
      if (!file) {
        createFile(getCurrentTimestamp(), editor.value);
      } else {
        file.content = editor.value;
      }
      showSaveFeedback();
      saveState();
    }




    /* --- Visual Save Feedback --- */
    function showSaveFeedback() {
      const f = document.createElement('div');
      f.textContent = 'Saved ‚úì';
      Object.assign(f.style, {
        position: 'fixed', bottom: '20px', right: '20px',
        background: '#007acc', color: '#fff',
        padding: '8px 12px', borderRadius: '4px',
        fontFamily: 'monospace', boxShadow: '0 2px 6px rgba(0,0,0,0.3)',
        zIndex: 9999
      });
      document.body.appendChild(f);
      setTimeout(() => f.remove(), 1200);
    }

    /* --- Rename/Close --- */
    function renameCurrentTab() {
      if (!activeTabId) return;
      const file = files.find(f => f.id === activeTabId);
      const n = prompt("New name?", file.name);
      if (n && n.trim() !== '') { file.name = n.trim(); renderTabs(); saveState(); }
    }
    function closeCurrentTab() { if (activeTabId) closeTab(activeTabId); }

    /* --- Search --- */
    function searchTabs(query) {
      if (!query) return;

      const res = files.filter(f => f.content.includes(query));
      if (!res.length) { alert('No results found'); return; }

      const file = res[0];
      openFile(file.id);

      const idx = file.content.indexOf(query);
      isProgrammaticChange = true;
      editor.focus();
      editor.setSelectionRange(idx, idx + query.length);
      setTimeout(() => { isProgrammaticChange = false; }, 0);
    }

    /* --- File Picker Overlay --- */
    function openPicker() {
      pickerOverlay.style.display = 'block';
      pickerInput.value = '';
      pickerInput.focus();
      renderPickerList();
    }

        function closePicker() { pickerOverlay.style.display = 'none'; }


    function togglePicker() {
      if (pickerOverlay.style.display === 'block') {
        // Currently open ‚Üí hide it
        pickerOverlay.style.display = 'none';
      } else {
        // Currently hidden ‚Üí show it
        pickerOverlay.style.display = 'block';
        pickerInput.value = '';
        pickerInput.focus();
        renderPickerList();
      }
    }


    function toggleHelp() {
      helpOverlay.style.display = helpOverlay.style.display === 'block' ? 'none' : 'block';
    }

    function closeHelp() {
      helpOverlay.style.display = 'none';
    }

    function toggleSearch(){
      // searchBar.style.display = 'block'; searchInput.focus();
      if (searchBar.style.display === 'block'){
        closeSearch();
      }
      else { 
        openSearch();
       }
    }

    function openSearch(){
      searchBar.style.display = 'block'; searchInput.focus();
    }

    function closeSearch(){
     searchBar.style.display = 'none'; searchInput.value = '';
    }


    function renderPickerList(filter = '') {
      pickerList.innerHTML = '';
      files.filter(f => f.name.toLowerCase().includes(filter.toLowerCase())).forEach((f, i) => {
        const el = document.createElement('div');
        el.textContent = f.name;
        el.dataset.id = f.id;
        el.className = i === 0 ? 'selected' : '';
        el.onclick = () => { openFile(f.id); closePicker(); };
        pickerList.appendChild(el);
      });
    }


    function getCurrentTimestamp() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}-${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
    }

    /* --- Event Listeners --- */
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); saveTab(); } // good 
      if ((e.ctrlKey && e.key.toLowerCase() === 'k') || (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'f')) { e.preventDefault(); toggleSearch(); }
      if (e.altKey && e.key.toLowerCase() === 'w') { e.preventDefault(); closeCurrentTab(); }
      if (e.altKey && e.key.toLowerCase() === 'n') { e.preventDefault(); createFile(getCurrentTimestamp()); }
      if (e.altKey && e.key.toLowerCase() === 'h') { e.preventDefault(); toggleHelp() }
      if (e.key === 'F2') { e.preventDefault(); renameCurrentTab(); }
      if (e.key === 'Escape') { closeSearch(); closePicker(); closeHelp(); }
      if (e.ctrlKey && (e.key.toLowerCase() === 'e' || e.key.toLowerCase() === 'p')) { e.preventDefault(); togglePicker(); }
    });

    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') { searchTabs(searchInput.value); closeSearch() }
    });
    editor.addEventListener('input', () => {
      if (isProgrammaticChange) return;

      if (!activeTabId && editor.value.trim() !== '') {
        createFile(getCurrentTimestamp(), editor.value);
      } else {
        const file = files.find(f => f.id === activeTabId);
        if (!file) createFile(getCurrentTimestamp(), editor.value);
        else file.content = editor.value;
        saveState();
      }
    });


    pickerInput.addEventListener('input', e => { renderPickerList(e.target.value); });
    pickerInput.addEventListener('keydown', e => {
      const items = Array.from(pickerList.children);
      let selectedIndex = items.findIndex(i => i.classList.contains('selected'));
      if (e.key === 'ArrowDown') { e.preventDefault(); if (selectedIndex < items.length - 1) { items[selectedIndex].classList.remove('selected'); selectedIndex++; items[selectedIndex].classList.add('selected'); } }
      if (e.key === 'ArrowUp') { e.preventDefault(); if (selectedIndex > 0) { items[selectedIndex].classList.remove('selected'); selectedIndex--; items[selectedIndex].classList.add('selected'); } }
      if (e.key === 'Enter') { e.preventDefault(); if (items[selectedIndex]) { openFile(Number(items[selectedIndex].dataset.id)); closePicker(); } }
    });

    /* --- Initialize --- */
    loadState();
    if (openTabs.length) setActiveTab(activeTabId || openTabs[0]);

  </script>

</body>

</html>